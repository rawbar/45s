<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>45s Card Game</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Palatino Linotype', Palatino, Georgia, serif; overflow: hidden; }
    html, body, #root { height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
// 45s Card Game - Version 1.1
const { useState, useCallback, useRef, useEffect } = React;
const VERSION = '1.1';

const SUITS = ['♠', '♥', '♦', '♣'];
const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
const PLAYER_NAMES = ['You', 'Player 2', 'Partner', 'Player 4'];
const getTeam = (player) => player % 2 === 0 ? 0 : 1;

function getTrumpRank(card, trumpSuit) {
  if (!card || !trumpSuit) return -1;
  const { rank, suit } = card;
  if (rank === 'A' && suit === '♥') return 100;
  if (suit !== trumpSuit) return -1;
  if (rank === '5') return 102;
  if (rank === 'J') return 101;
  if (rank === 'A') return 99;
  if (rank === 'K') return 98;
  if (rank === 'Q') return 97;
  if (suit === '♥' || suit === '♦') {
    return 80 + ['2','3','4','6','7','8','9','10'].indexOf(rank);
  } else {
    return 80 + ['10','9','8','7','6','4','3','2'].indexOf(rank);
  }
}

function getOffSuitRank(card) {
  if (!card) return -1;
  const { rank, suit } = card;
  if (suit === '♥' || suit === '♦') {
    return ['A','2','3','4','5','6','7','8','9','10','J','Q','K'].indexOf(rank);
  }
  return ['10','9','8','7','6','5','4','3','2','A','J','Q','K'].indexOf(rank);
}

function cardBeats(c1, c2, trumpSuit, ledSuit) {
  const t1 = getTrumpRank(c1, trumpSuit), t2 = getTrumpRank(c2, trumpSuit);
  if (t1 >= 0 && t2 >= 0) return t1 > t2;
  if (t1 >= 0) return true;
  if (t2 >= 0) return false;
  if (c1.suit !== ledSuit) return false;
  if (c2.suit !== ledSuit) return true;
  return getOffSuitRank(c1) > getOffSuitRank(c2);
}

function isTopThreeTrump(card, trumpSuit) {
  if (!card || !trumpSuit) return false;
  return (card.rank === '5' && card.suit === trumpSuit) || (card.rank === 'J' && card.suit === trumpSuit) || (card.rank === 'A' && card.suit === '♥');
}

function isTrump(card, trumpSuit) {
  if (!card || !trumpSuit) return false;
  return (card.rank === 'A' && card.suit === '♥') || card.suit === trumpSuit;
}

function createDeck() {
  const deck = [];
  for (const suit of SUITS) for (const rank of RANKS) deck.push({ rank, suit, id: `${rank}${suit}` });
  return deck;
}

function shuffleDeck(deck) {
  const s = [...deck];
  for (let i = s.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [s[i], s[j]] = [s[j], s[i]]; }
  return s;
}

function getPlayableCards(hand, trumpSuit, ledCard, ledSuit) {
  if (!hand || hand.length === 0) return [];
  if (!ledCard) return hand;
  if (isTrump(ledCard, trumpSuit)) {
    const trumpCards = hand.filter(c => isTrump(c, trumpSuit));
    if (trumpCards.length === 0) return hand;
    const ledRank = getTrumpRank(ledCard, trumpSuit);
    const must = [], canRenege = [];
    for (const c of trumpCards) {
      if (isTopThreeTrump(c, trumpSuit) && getTrumpRank(c, trumpSuit) > ledRank) canRenege.push(c);
      else must.push(c);
    }
    return must.length > 0 ? [...must, ...canRenege] : hand;
  } else {
    const follow = hand.filter(c => c.suit === ledSuit && !isTrump(c, trumpSuit));
    const trumps = hand.filter(c => isTrump(c, trumpSuit));
    return follow.length === 0 ? hand : [...follow, ...trumps];
  }
}

function determineTrickWinner(trick, trumpSuit, startPlayer) {
  if (trick.length !== 4) return null;
  const ledSuit = trick[0].suit;
  let winIdx = 0, winCard = trick[0];
  for (let i = 1; i < 4; i++) { if (cardBeats(trick[i], winCard, trumpSuit, ledSuit)) { winIdx = i; winCard = trick[i]; } }
  return (startPlayer + winIdx) % 4;
}

const hasCard = (hand, rank, suit) => hand.some(c => c.rank === rank && c.suit === suit);
const hasFive = (hand, trump) => hasCard(hand, '5', trump);
const hasJack = (hand, trump) => hasCard(hand, 'J', trump);
const hasAceHearts = (hand) => hasCard(hand, 'A', '♥');
const countTrumps = (hand, trump) => hand.filter(c => isTrump(c, trump)).length;
const countHighTrumps = (hand, trump) => hand.filter(c => getTrumpRank(c, trump) >= 97).length;

function findBestTrumpSuit(hand) {
  let best = '♠', bestCount = 0, best5 = false, bestJ = false;
  for (const suit of SUITS) {
    const count = countTrumps(hand, suit), h5 = hasFive(hand, suit), hJ = hasJack(hand, suit);
    const score = (h5?1000:0) + (hJ?500:0) + count*10;
    const bestScore = (best5?1000:0) + (bestJ?500:0) + bestCount*10;
    if (score > bestScore) { best = suit; bestCount = count; best5 = h5; bestJ = hJ; }
  }
  return { suit: best, trumpCount: bestCount, has5: best5, hasJ: bestJ };
}

function decideBid(hand, currentHighBid, playerIndex, dealer, teamScores, oppScores) {
  const { suit, trumpCount, has5, hasJ } = findBestTrumpSuit(hand);
  const hasAH = hasAceHearts(hand), highT = countHighTrumps(hand, suit);
  const theyWin = (b) => oppScores + b >= 120;
  const farAhead = teamScores >= 100 && teamScores - oppScores >= 30;
  let bid = 0;
  if (has5 && hasJ && hasAH && trumpCount >= 4) bid = 30;
  else if (has5 && hasJ && trumpCount >= 3) bid = 25;
  else if (has5 && hasAH && trumpCount >= 4) bid = 25;
  else if (has5 && trumpCount >= 3) bid = 20;
  else if (has5 && trumpCount >= 2 && highT >= 2) bid = 20;
  else if (hasJ && trumpCount >= 4 && highT >= 3) bid = 20;
  else if (has5) bid = 15;
  else if (hasJ && trumpCount >= 3) bid = 15;
  else if (hasAH && trumpCount >= 3) bid = 15;
  else if (trumpCount >= 4 && highT >= 2) bid = 15;
  if (theyWin(20) && bid < 20 && ((has5 && trumpCount >= 2) || (hasJ && trumpCount >= 3))) bid = 20;
  if (theyWin(20) && currentHighBid >= 20 && bid < 25 && ((has5 && hasJ) || (has5 && trumpCount >= 4))) bid = 25;
  if (farAhead && !has5 && !hasJ) bid = 0;
  if (bid <= currentHighBid) return playerIndex === dealer && currentHighBid === 0 ? { bid: 15, suit } : { bid: 0, suit: null };
  return { bid, suit };
}

function decideDiscard(hand, trumpSuit, isBidWinner) {
  const trumps = hand.filter(c => isTrump(c, trumpSuit));
  const offsuit = hand.filter(c => !isTrump(c, trumpSuit));
  let keep = [...trumps];
  if (isBidWinner) {
    const kings = offsuit.filter(c => c.rank === 'K');
    if (kings.length > 0 && trumps.length >= 3) keep.push(kings[0]);
  }
  if (keep.length === 0 && hand.length > 0) {
    const sorted = [...hand].sort((a,b) => {
      const ar = isTrump(a,trumpSuit) ? getTrumpRank(a,trumpSuit)+100 : getOffSuitRank(a);
      const br = isTrump(b,trumpSuit) ? getTrumpRank(b,trumpSuit)+100 : getOffSuitRank(b);
      return br - ar;
    });
    keep = [sorted[0]];
  }
  return { keep, discard: hand.filter(c => !keep.some(k => k.id === c.id)) };
}

function getDefaultDiscardSelection(hand, trumpSuit) {
  return hand.map((c, i) => isTrump(c, trumpSuit) ? -1 : i).filter(i => i >= 0);
}

function chooseCardToPlay(hand, trumpSuit, trick, leader, player, bidWinner, highBid, cardsDrawn) {
  const led = trick[0] || null, ledSuit = led?.suit;
  const playable = getPlayableCards(hand, trumpSuit, led, ledSuit);
  if (playable.length <= 1) return playable[0] || hand[0];
  
  const myTeam = getTeam(player), partnerIdx = (player + 2) % 4;
  const myTeamBid = myTeam === getTeam(bidWinner);
  const partnerIsBidder = partnerIdx === bidWinner;
  const oppWeak = (cardsDrawn[(player+1)%4]||0) >= 4 && (cardsDrawn[(player+3)%4]||0) >= 4;
  const partnerWeak = (cardsDrawn[partnerIdx]||0) >= 4;

  if (!led) {
    const trumps = playable.filter(c => isTrump(c, trumpSuit));
    const nonTrumps = playable.filter(c => !isTrump(c, trumpSuit));
    if (myTeamBid && trumps.length >= 2) {
      const has5 = trumps.some(c => c.rank === '5' && c.suit === trumpSuit);
      if (has5 && oppWeak) return trumps.find(c => c.rank === '5' && c.suit === trumpSuit);
      return trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
    }
    if (partnerIsBidder && !partnerWeak && nonTrumps.length > 0) {
      return nonTrumps.reduce((l,c) => getOffSuitRank(c) < getOffSuitRank(l) ? c : l);
    }
    return playable.reduce((l,c) => {
      const cr = isTrump(c,trumpSuit) ? getTrumpRank(c,trumpSuit)+100 : getOffSuitRank(c);
      const lr = isTrump(l,trumpSuit) ? getTrumpRank(l,trumpSuit)+100 : getOffSuitRank(l);
      return cr < lr ? c : l;
    });
  }

  let winIdx = 0, winCard = trick[0];
  for (let i = 1; i < trick.length; i++) { if (cardBeats(trick[i], winCard, trumpSuit, ledSuit)) { winIdx = i; winCard = trick[i]; } }
  const winPlayer = (leader + winIdx) % 4;
  const partnerWinning = getTeam(winPlayer) === myTeam;

  // Third man high
  if (trick.length === 2 && partnerIdx === bidWinner && bidWinner === leader && !isTrump(led, trumpSuit) && myTeamBid) {
    const trumps = playable.filter(c => isTrump(c, trumpSuit));
    if (trumps.length > 0) return trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
  }

  if (partnerWinning) {
    return playable.reduce((l,c) => {
      const cr = isTrump(c,trumpSuit) ? getTrumpRank(c,trumpSuit)+200 : getOffSuitRank(c);
      const lr = isTrump(l,trumpSuit) ? getTrumpRank(l,trumpSuit)+200 : getOffSuitRank(l);
      return cr < lr ? c : l;
    });
  }

  const canWin = playable.filter(c => cardBeats(c, winCard, trumpSuit, ledSuit));
  if (canWin.length > 0) {
    return canWin.reduce((l,c) => {
      const cr = isTrump(c,trumpSuit) ? getTrumpRank(c,trumpSuit) : getOffSuitRank(c);
      const lr = isTrump(l,trumpSuit) ? getTrumpRank(l,trumpSuit) : getOffSuitRank(l);
      return cr < lr ? c : l;
    });
  }

  // Can't win - prefer offsuit over trump
  const nonTrump = playable.filter(c => !isTrump(c, trumpSuit));
  if (nonTrump.length > 0) return nonTrump.reduce((l,c) => getOffSuitRank(c) < getOffSuitRank(l) ? c : l);
  return playable.reduce((l,c) => getTrumpRank(c,trumpSuit) < getTrumpRank(l,trumpSuit) ? c : l);
}

const chooseTrumpSuit = (hand) => findBestTrumpSuit(hand).suit;

// UI Components
function TrickMarker({ isHighTrump }) {
  return (<div style={{ width: '16px', height: '22px', borderRadius: '3px', background: isHighTrump ? 'linear-gradient(135deg, #8b0000 0%, #5c0000 100%)' : 'linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%)', border: isHighTrump ? '1px solid #ff6666' : '1px solid #2d5a87', boxShadow: isHighTrump ? '0 1px 3px rgba(255,0,0,0.4)' : '0 1px 3px rgba(0,0,0,0.3)' }} />);
}

function TricksWonDisplay({ count, hasHighTrump }) {
  if (count === 0) return <div style={{ minHeight: '26px' }} />;
  return (<div style={{ display: 'flex', gap: '2px', minHeight: '26px' }}>{Array.from({ length: count }, (_, i) => <TrickMarker key={i} isHighTrump={hasHighTrump && i === 0} />)}</div>);
}

function CardsDrawnIndicator({ count }) {
  if (count === 0) return null;
  return (<div style={{ fontSize: '10px', color: '#aaa' }}>drew {count}</div>);
}

function DealerBadge() {
  return (<div style={{ padding: '1px 6px', background: '#d4af37', color: '#000', borderRadius: '3px', fontSize: '9px', fontWeight: 'bold' }}>DEALER</div>);
}

function Card({ card, onClick, disabled, selected, small, faceDown, playable }) {
  const isRed = card && (card.suit === '♥' || card.suit === '♦');
  const w = small ? '36px' : '56px', h = small ? '50px' : '78px';
  const base = { width: w, height: h, borderRadius: '6px', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', cursor: disabled ? 'default' : 'pointer', transition: 'all 0.15s', fontFamily: 'Georgia, serif', userSelect: 'none', flexShrink: 0 };
  if (faceDown) return (<div style={{ ...base, background: 'linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%)', border: '2px solid #2d5a87' }}><div style={{ width: '75%', height: '75%', border: '1px solid #3d7ab7', borderRadius: '3px', background: 'repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(61,122,183,0.1) 2px, rgba(61,122,183,0.1) 4px)' }} /></div>);
  return (
    <div onClick={disabled ? undefined : onClick} style={{ ...base, background: selected ? '#fffde7' : '#fff', border: playable ? '3px solid #2196f3' : selected ? '3px solid #ffc107' : '2px solid #ccc', boxShadow: selected ? '0 3px 10px rgba(255,193,7,0.4)' : playable ? '0 3px 10px rgba(33,150,243,0.3)' : '0 2px 6px rgba(0,0,0,0.15)', transform: (selected || playable) && !disabled ? 'translateY(-3px)' : 'none', opacity: disabled && !playable ? 0.6 : 1 }}>
      <div style={{ color: isRed ? '#c62828' : '#212121', fontSize: small ? '13px' : '17px', fontWeight: 'bold', lineHeight: 1 }}>{card.rank}</div>
      <div style={{ color: isRed ? '#c62828' : '#212121', fontSize: small ? '18px' : '26px', lineHeight: 1 }}>{card.suit}</div>
    </div>
  );
}

function ScoreTable({ roundHistory }) {
  const [expanded, setExpanded] = useState(false);
  if (roundHistory.length === 0) return null;
  const maxVis = 3, needsCollapse = roundHistory.length > maxVis;
  const visible = (!needsCollapse || expanded) ? roundHistory : roundHistory.slice(-maxVis);
  const hidden = roundHistory.length - maxVis;
  return (
    <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: '6px', padding: '8px', fontSize: '12px' }}>
      {needsCollapse && !expanded && <div onClick={() => setExpanded(true)} style={{ textAlign: 'center', marginBottom: '4px', color: '#aaa', cursor: 'pointer', fontSize: '10px' }}>▲ Show {hidden} more ▲</div>}
      {needsCollapse && expanded && <div onClick={() => setExpanded(false)} style={{ textAlign: 'center', marginBottom: '4px', color: '#aaa', cursor: 'pointer', fontSize: '10px' }}>▼ Show less ▼</div>}
      <table style={{ width: '100%', borderCollapse: 'collapse', textAlign: 'center' }}>
        <thead><tr><th style={{ padding: '2px 4px', borderBottom: '1px solid rgba(255,255,255,0.3)', fontSize: '10px' }}>Rnd</th><th colSpan="2" style={{ padding: '2px 4px', borderBottom: '1px solid rgba(255,255,255,0.3)', color: '#4caf50', fontSize: '10px' }}>US</th><th colSpan="2" style={{ padding: '2px 4px', borderBottom: '1px solid rgba(255,255,255,0.3)', color: '#f44336', fontSize: '10px' }}>THEM</th></tr></thead>
        <tbody>{visible.map((r, i) => {
          const rn = expanded || !needsCollapse ? i + 1 : roundHistory.length - maxVis + i + 1;
          return (<tr key={i}><td style={{ padding: '2px 4px' }}>{rn}</td><td style={{ padding: '2px 4px', color: '#4caf50' }}>{r.usRoundScore < 0 ? `(${Math.abs(r.usRoundScore)})` : r.usRoundScore}</td><td style={{ padding: '2px 4px', color: '#4caf50', fontWeight: 'bold' }}>{r.usTotal < 0 ? `(${Math.abs(r.usTotal)})` : r.usTotal}</td><td style={{ padding: '2px 4px', color: '#f44336' }}>{r.themRoundScore < 0 ? `(${Math.abs(r.themRoundScore)})` : r.themRoundScore}</td><td style={{ padding: '2px 4px', color: '#f44336', fontWeight: 'bold' }}>{r.themTotal < 0 ? `(${Math.abs(r.themTotal)})` : r.themTotal}</td></tr>);
        })}</tbody>
      </table>
    </div>
  );
}

function FortyFivesGame() {
  const [phase, setPhase] = useState('dealing');
  const [hands, setHands] = useState([[],[],[],[]]);
  const [kitty, setKitty] = useState([]);
  const [deck, setDeck] = useState([]);
  const [dealer, setDealer] = useState(0);
  const [currentPlayer, setCurrentPlayer] = useState(1);
  const [bids, setBids] = useState([null,null,null,null]);
  const [highBid, setHighBid] = useState(0);
  const [bidWinner, setBidWinner] = useState(null);
  const [trumpSuit, setTrumpSuit] = useState(null);
  const [trick, setTrick] = useState([]);
  const [trickCards, setTrickCards] = useState([]);
  const [trickLeader, setTrickLeader] = useState(null);
  const [tricksWon, setTricksWon] = useState([0,0]);
  const [playerTricks, setPlayerTricks] = useState([0,0,0,0]);
  const [roundPts, setRoundPts] = useState([0,0]);
  const [scores, setScores] = useState([0,0]);
  const [trickNum, setTrickNum] = useState(0);
  const [selected, setSelected] = useState([]);
  const [msg, setMsg] = useState('');
  const [lastTrick, setLastTrick] = useState(null);
  const [aiTrump, setAiTrump] = useState(null);
  const [highTrumpInfo, setHighTrumpInfo] = useState({ rank: -1, player: -1 });
  const [history, setHistory] = useState([]);
  const [drawn, setDrawn] = useState([0,0,0,0]);
  const [animating, setAnimating] = useState(null);
  const timer = useRef(null);
  
  useEffect(() => () => { if (timer.current) clearTimeout(timer.current); }, []);

  const startGame = useCallback(() => {
    if (timer.current) clearTimeout(timer.current);
    setScores([0,0]); setHistory([]); setDealer(0); dealRound(0, [0,0]);
  }, []);

  const dealRound = useCallback((dlr, totals) => {
    const d = shuffleDeck(createDeck());
    const h = [d.slice(0,5), d.slice(5,10), d.slice(10,15), d.slice(15,20)];
    const k = d.slice(20,23), rem = d.slice(23);
    setHands(h); setKitty(k); setDeck(rem);
    setBids([null,null,null,null]); setHighBid(0); setBidWinner(null); setTrumpSuit(null);
    setTrick([]); setTrickCards([]); setTricksWon([0,0]); setPlayerTricks([0,0,0,0]);
    setRoundPts([0,0]); setTrickNum(0); setSelected([]); setLastTrick(null);
    setAiTrump(null); setTrickLeader(null); setHighTrumpInfo({ rank: -1, player: -1 });
    setDrawn([0,0,0,0]); setAnimating(null); setPhase('bidding');
    const first = (dlr + 1) % 4; setCurrentPlayer(first);
    if (first !== 0) { setMsg(`${PLAYER_NAMES[first]} is bidding...`); timer.current = setTimeout(() => doBid(first, h, dlr, [null,null,null,null], 0, totals), 1000); }
    else setMsg('Your turn to bid');
  }, []);

  const doBid = useCallback((p, h, dlr, curBids, curHigh, totals) => {
    if (p === 0) return;
    const team = totals[getTeam(p)], opp = totals[1-getTeam(p)];
    const dec = decideBid(h[p], curHigh, p, dlr, team, opp);
    const newBids = [...curBids]; newBids[p] = dec.bid; setBids(newBids);
    let newHigh = curHigh, winner = null;
    if (dec.bid > curHigh) { newHigh = dec.bid; setHighBid(dec.bid); setAiTrump(dec.suit); winner = p; }
    if (newBids.every(b => b !== null)) {
      let fw = winner; if (!fw) { let m = 0; for (let i = 0; i < 4; i++) if (newBids[i] > m) { m = newBids[i]; fw = i; } }
      if (newHigh === 0) { fw = dlr; newBids[dlr] = 15; setBids(newBids); setHighBid(15); newHigh = 15; }
      setBidWinner(fw);
      if (fw === 0) { setPhase('trump-select'); setMsg('Select trump suit'); }
      else { const t = aiTrump || chooseTrumpSuit(h[fw]); finishBid(fw, t, h, newHigh, totals, dlr); }
    } else {
      const next = (p + 1) % 4; setCurrentPlayer(next);
      if (next === 0) setMsg('Your turn to bid');
      else { setMsg(`${PLAYER_NAMES[next]} is bidding...`); timer.current = setTimeout(() => doBid(next, h, dlr, newBids, newHigh, totals), 1000); }
    }
  }, [aiTrump]);

  const humanBid = useCallback((amt) => {
    const newBids = [...bids]; newBids[0] = amt; setBids(newBids);
    let newHigh = highBid; if (amt > highBid) { newHigh = amt; setHighBid(amt); }
    if (newBids.every(b => b !== null)) {
      let w = null, m = 0; for (let i = 0; i < 4; i++) if (newBids[i] > m) { m = newBids[i]; w = i; }
      if (m === 0) { w = dealer; newBids[dealer] = 15; setBids(newBids); setHighBid(15); newHigh = 15; }
      setBidWinner(w);
      if (w === 0) { setPhase('trump-select'); setMsg('Select trump suit'); }
      else { const t = aiTrump || chooseTrumpSuit(hands[w]); finishBid(w, t, hands, newHigh, scores, dealer); }
    } else { setCurrentPlayer(1); setMsg(`${PLAYER_NAMES[1]} is bidding...`); timer.current = setTimeout(() => doBid(1, hands, dealer, newBids, newHigh, scores), 1000); }
  }, [bids, highBid, dealer, hands, aiTrump, scores]);

  const selectTrump = useCallback((s) => finishBid(0, s, hands, highBid, scores, dealer), [hands, highBid, scores, dealer]);

  const finishBid = useCallback((w, t, h, hb, totals, dlr) => {
    setTrumpSuit(t); setBidWinner(w); setHighBid(hb);
    const newH = h.map((hand, i) => i === w ? [...hand, ...kitty] : [...hand]);
    setHands(newH); setKitty([]);
    setSelected(getDefaultDiscardSelection(newH[0], t));
    const first = (dlr + 1) % 4; setPhase('discarding'); setCurrentPlayer(first);
    if (first === 0) setMsg('Select cards to discard - keep at least 1');
    else { setMsg(`${PLAYER_NAMES[first]} discarding...`); timer.current = setTimeout(() => aiDiscard(first, newH, t, w, hb, totals, dlr, [0,0,0,0], deck), 700); }
  }, [kitty, deck]);

  const aiDiscard = useCallback((p, h, t, bw, hb, totals, dlr, curDrawn, curDeck) => {
    const { keep } = decideDiscard(h[p], t, p === bw);
    const newH = h.map(x => [...x]); newH[p] = keep;
    let d = [...curDeck]; const dc = 5 - keep.length;
    if (dc > 0 && d.length >= dc) { newH[p] = [...newH[p], ...d.splice(0, dc)]; }
    const newDrawn = [...curDrawn]; newDrawn[p] = dc;
    setHands(newH); setDeck(d); setDrawn(newDrawn);
    const next = (p + 1) % 4, start = (dlr + 1) % 4;
    if (next === start) startPlay(bw, newH, t, hb, totals, newDrawn);
    else { setCurrentPlayer(next);
      if (next === 0) { setSelected(getDefaultDiscardSelection(newH[0], t)); setMsg('Select cards to discard - keep at least 1'); }
      else { setMsg(`${PLAYER_NAMES[next]} discarding...`); timer.current = setTimeout(() => aiDiscard(next, newH, t, bw, hb, totals, dlr, newDrawn, d), 700); }
    }
  }, []);

  const humanDiscard = useCallback(() => {
    const keep = hands[0].filter((_, i) => !selected.includes(i));
    if (keep.length === 0) { setMsg('Must keep at least 1 card!'); return; }
    const newH = hands.map(x => [...x]); newH[0] = keep;
    let d = [...deck]; const dc = 5 - keep.length;
    if (dc > 0 && d.length >= dc) { newH[0] = [...newH[0], ...d.splice(0, dc)]; }
    const newDrawn = [...drawn]; newDrawn[0] = dc;
    setHands(newH); setDeck(d); setDrawn(newDrawn); setSelected([]);
    const next = 1, start = (dealer + 1) % 4;
    if (next === start) startPlay(bidWinner, newH, trumpSuit, highBid, scores, newDrawn);
    else { setCurrentPlayer(next); setMsg(`${PLAYER_NAMES[next]} discarding...`); timer.current = setTimeout(() => aiDiscard(next, newH, trumpSuit, bidWinner, highBid, scores, dealer, newDrawn, d), 700); }
  }, [hands, selected, deck, dealer, bidWinner, trumpSuit, highBid, scores, drawn]);

  const startPlay = useCallback((leader, h, t, hb, totals, dr) => {
    setPhase('playing'); setTrick([]); setTrickCards([]); setTrickLeader(leader);
    setCurrentPlayer(leader); setTrickNum(1); setPlayerTricks([0,0,0,0]); setHighTrumpInfo({ rank: -1, player: -1 });
    if (leader === 0) setMsg('Your lead');
    else { setMsg(`${PLAYER_NAMES[leader]} leads...`); timer.current = setTimeout(() => aiPlay(leader, h, [], t, leader, 1, [0,0], [0,0], { rank: -1, player: -1 }, bidWinner, hb, totals, dr, [0,0,0,0]), 900); }
  }, [bidWinner]);

  const aiPlay = useCallback((p, h, tc, t, lead, tn, tw, rp, hti, bw, hb, totals, dr, pt) => {
    const hand = h[p]; if (!hand || !hand.length) return;
    const trk = tc.map(x => x.card);
    const card = chooseCardToPlay(hand, t, trk, lead, p, bw, hb, dr);
    const idx = hand.findIndex(c => c.id === card.id);
    const newH = h.map((x, i) => i === p ? x.filter((_, j) => j !== idx) : [...x]);
    const newTC = [...tc, { card, player: p }], newTrk = newTC.map(x => x.card);
    setHands(newH); setTrickCards(newTC); setTrick(newTrk);
    if (newTC.length === 4) timer.current = setTimeout(() => evalTrick(newTrk, newTC, t, lead, newH, tn, tw, rp, hti, bw, hb, totals, dr, pt), 600);
    else { const next = (p + 1) % 4; setCurrentPlayer(next);
      if (next === 0) setMsg('Your turn');
      else { setMsg(`${PLAYER_NAMES[next]} playing...`); timer.current = setTimeout(() => aiPlay(next, newH, newTC, t, lead, tn, tw, rp, hti, bw, hb, totals, dr, pt), 700); }
    }
  }, []);

  const humanPlay = useCallback((ci) => {
    if (phase !== 'playing' || currentPlayer !== 0) return;
    const hand = hands[0], card = hand[ci];
    const led = trick[0] || null, ls = led?.suit;
    const playable = getPlayableCards(hand, trumpSuit, led, ls);
    if (!playable.some(c => c.id === card.id)) { setMsg('Must follow suit or play trump!'); return; }
    const newH = hands.map((x, i) => i === 0 ? x.filter((_, j) => j !== ci) : [...x]);
    const newTC = [...trickCards, { card, player: 0 }], newTrk = newTC.map(x => x.card);
    setHands(newH); setTrickCards(newTC); setTrick(newTrk);
    if (newTC.length === 4) timer.current = setTimeout(() => evalTrick(newTrk, newTC, trumpSuit, trickLeader, newH, trickNum, tricksWon, roundPts, highTrumpInfo, bidWinner, highBid, scores, drawn, playerTricks), 600);
    else { setCurrentPlayer(1); setMsg(`${PLAYER_NAMES[1]} playing...`); timer.current = setTimeout(() => aiPlay(1, newH, newTC, trumpSuit, trickLeader, trickNum, tricksWon, roundPts, highTrumpInfo, bidWinner, highBid, scores, drawn, playerTricks), 700); }
  }, [phase, currentPlayer, hands, trick, trickCards, trumpSuit, trickLeader, trickNum, tricksWon, roundPts, highTrumpInfo, bidWinner, highBid, scores, drawn, playerTricks]);

  const evalTrick = useCallback((trk, tc, t, lead, h, tn, tw, rp, hti, bw, hb, totals, dr, pt) => {
    const winner = determineTrickWinner(trk, t, lead), team = getTeam(winner);
    let highT = -1; for (const c of trk) { const r = getTrumpRank(c, t); if (r > highT) highT = r; }
    let newHTI = hti; if (highT > hti.rank) newHTI = { rank: highT, player: winner };
    setHighTrumpInfo(newHTI);
    const newTW = [...tw]; newTW[team]++;
    const newPT = [...pt]; newPT[winner]++;
    const newRP = [...rp]; newRP[team] += 5;
    setTricksWon(newTW); setPlayerTricks(newPT); setRoundPts(newRP);
    setLastTrick({ cards: tc, winner }); setAnimating(winner); setPhase('trick-end');
    setMsg(`${PLAYER_NAMES[winner]} wins!`);
    timer.current = setTimeout(() => {
      setAnimating(null);
      if (tn >= 5) { const fp = [...newRP]; if (newHTI.rank >= 0) fp[getTeam(newHTI.player)] += 5; endRound(fp, h, bw, hb, totals); }
      else { setTrick([]); setTrickCards([]); setTrickLeader(winner); setCurrentPlayer(winner); setTrickNum(tn + 1); setPhase('playing');
        if (winner === 0) setMsg('Your lead');
        else { setMsg(`${PLAYER_NAMES[winner]} leads...`); timer.current = setTimeout(() => aiPlay(winner, h, [], t, winner, tn + 1, newTW, newRP, newHTI, bw, hb, totals, dr, newPT), 800); }
      }
    }, 1400);
  }, []);

  const endRound = useCallback((fp, h, bw, hb, totals) => {
    const bt = getTeam(bw), newS = [...totals];
    let us = 0, them = 0;
    if (fp[bt] >= hb) { newS[bt] += fp[bt]; bt === 0 ? us = fp[0] : them = fp[1]; }
    else { newS[bt] -= hb; bt === 0 ? us = -hb : them = -hb; }
    const ot = 1 - bt; newS[ot] += fp[ot]; ot === 0 ? us = fp[0] : them = fp[1];
    setScores(newS);
    setHistory(p => [...p, { usRoundScore: us, themRoundScore: them, usTotal: newS[0], themTotal: newS[1] }]);
    if (newS[0] >= 120 || newS[1] >= 120) {
      const w = (newS[0] >= 120 && newS[1] >= 120) ? bt : (newS[0] >= 120 ? 0 : 1);
      setPhase('game-over'); setMsg(`${w === 0 ? 'Your team' : 'Opponents'} wins!`);
    } else {
      setPhase('round-end');
      const made = fp[bt] >= hb;
      setMsg(`${bt === 0 ? 'Your team' : 'Opponents'} ${made ? 'made' : 'missed'} ${hb} (got ${fp[bt]})`);
    }
  }, []);

  const nextRound = useCallback(() => { const nd = (dealer + 1) % 4; setDealer(nd); dealRound(nd, scores); }, [dealer, scores]);
  const toggle = useCallback((i) => setSelected(p => p.includes(i) ? p.filter(x => x !== i) : [...p, i]), []);

  const playable = phase === 'playing' && currentPlayer === 0 ? (() => {
    const led = trick[0] || null, ls = led?.suit;
    const p = getPlayableCards(hands[0], trumpSuit, led, ls);
    return hands[0].map((c, i) => p.some(x => x.id === c.id) ? i : -1).filter(i => i >= 0);
  })() : [];

  const bidInd = (pi) => {
    if (phase === 'bidding') { if (bids[pi] === null) return null; return <div style={{ padding: '3px 6px', background: bids[pi] > 0 ? '#2196f3' : 'rgba(0,0,0,0.5)', borderRadius: '4px', fontSize: '12px' }}>{bids[pi] > 0 ? bids[pi] : 'Pass'}</div>; }
    if (bidWinner !== pi || !trumpSuit) return null;
    return <div style={{ padding: '3px 6px', background: '#2196f3', borderRadius: '4px', fontSize: '12px', display: 'flex', alignItems: 'center', gap: '3px' }}>{highBid}<span style={{ color: (trumpSuit === '♥' || trumpSuit === '♦') ? '#ffcdd2' : '#fff' }}>{trumpSuit}</span></div>;
  };

  const winPos = (w) => ({ 0: { x: 0, y: 120 }, 1: { x: -120, y: 0 }, 2: { x: 0, y: -120 }, 3: { x: 120, y: 0 } }[w]);

  return (
    <div style={{ height: '100vh', maxHeight: '100vh', overflow: 'hidden', background: 'linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #0a1f12 100%)', padding: '6px', fontFamily: '"Palatino Linotype", Palatino, Georgia, serif', color: '#e8e4d9', display: 'flex', flexDirection: 'column' }}>
      {/* Header */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '6px 10px', background: 'rgba(0,0,0,0.3)', borderRadius: '8px', border: '1px solid rgba(212,175,55,0.3)', marginBottom: '6px', flexShrink: 0 }}>
        <div><div style={{ fontSize: '18px', fontWeight: 'bold', color: '#d4af37' }}>45s</div><div style={{ fontSize: '8px', color: '#666' }}>v{VERSION}</div></div>
        <div style={{ textAlign: 'right' }}>
          <div style={{ fontSize: '14px', display: 'flex', gap: '6px' }}><span style={{ color: '#4caf50' }}>Us: {scores[0] < 0 ? `(${Math.abs(scores[0])})` : scores[0]}</span><span>|</span><span style={{ color: '#f44336' }}>Them: {scores[1] < 0 ? `(${Math.abs(scores[1])})` : scores[1]}</span></div>
          {trumpSuit && <div style={{ fontSize: '11px' }}>Trump: <span style={{ fontSize: '16px', color: (trumpSuit === '♥' || trumpSuit === '♦') ? '#f44336' : '#fff' }}>{trumpSuit}</span>{bidWinner !== null && <span style={{ marginLeft: '6px' }}>({PLAYER_NAMES[bidWinner]} {highBid})</span>}</div>}
        </div>
      </div>
      {/* Message */}
      <div style={{ textAlign: 'center', padding: '6px', background: 'rgba(0,0,0,0.4)', borderRadius: '6px', fontSize: '13px', color: '#ffd700', marginBottom: '6px', flexShrink: 0, minHeight: '32px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>{msg}</div>
      {/* Game Area */}
      <div style={{ display: 'flex', flexDirection: 'column', flex: 1, minHeight: 0, gap: '4px' }}>
        {/* North */}
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', flexShrink: 0 }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><span style={{ fontSize: '11px', color: '#aaa' }}>{PLAYER_NAMES[2]}</span>{dealer === 2 && <DealerBadge />}</div>
          <div style={{ display: 'flex', gap: '2px', minHeight: '50px' }}>{Array.from({ length: 5 }, (_, i) => i < hands[2].length ? <Card key={i} card={{}} faceDown small /> : <div key={i} style={{ width: '36px' }} />)}</div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>{bidInd(2)}<CardsDrawnIndicator count={drawn[2]} /></div>
          <TricksWonDisplay count={playerTricks[2]} hasHighTrump={highTrumpInfo.player === 2} />
        </div>
        {/* Middle */}
        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flex: 1, minHeight: 0 }}>
          {/* West */}
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', width: '60px', flexShrink: 0 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '4px', flexWrap: 'wrap', justifyContent: 'center' }}><span style={{ fontSize: '10px', color: '#aaa' }}>{PLAYER_NAMES[1]}</span>{dealer === 1 && <DealerBadge />}</div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>{Array.from({ length: 5 }, (_, i) => i < hands[1].length ? <Card key={i} card={{}} faceDown small /> : <div key={i} style={{ height: '50px' }} />)}</div>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' }}>{bidInd(1)}<CardsDrawnIndicator count={drawn[1]} /></div>
            <TricksWonDisplay count={playerTricks[1]} hasHighTrump={highTrumpInfo.player === 1} />
          </div>
          {/* Center */}
          <div style={{ width: '140px', height: '140px', display: 'flex', justifyContent: 'center', alignItems: 'center', background: 'rgba(0,0,0,0.3)', borderRadius: '50%', border: '2px solid rgba(212,175,55,0.3)', position: 'relative', flexShrink: 0 }}>
            {trumpSuit && (phase === 'playing' || phase === 'trick-end') && <div style={{ fontSize: '36px', color: (trumpSuit === '♥' || trumpSuit === '♦') ? '#f44336' : '#fff', opacity: 0.3, position: 'absolute' }}>{trumpSuit}</div>}
            {trickCards.map((tc, i) => {
              const pos = [{ bottom: '6px', left: '50%', transform: 'translateX(-50%)' }, { left: '6px', top: '50%', transform: 'translateY(-50%)' }, { top: '6px', left: '50%', transform: 'translateX(-50%)' }, { right: '6px', top: '50%', transform: 'translateY(-50%)' }][tc.player];
              const ani = animating !== null, wp = ani ? winPos(animating) : null;
              return <div key={i} style={{ position: 'absolute', ...pos, zIndex: 1, transition: ani ? 'all 0.5s ease' : 'none', transform: ani ? `translate(${wp.x}px, ${wp.y}px) scale(0.3)` : pos.transform, opacity: ani ? 0 : 1 }}><Card card={tc.card} small disabled /></div>;
            })}
            {trumpSuit && trickCards.length === 0 && phase !== 'playing' && phase !== 'trick-end' && <div style={{ fontSize: '36px', color: (trumpSuit === '♥' || trumpSuit === '♦') ? '#f44336' : '#fff', opacity: 0.5 }}>{trumpSuit}</div>}
            {(phase === 'playing' || phase === 'trick-end') && <div style={{ position: 'absolute', bottom: '-20px', fontSize: '10px', color: '#aaa' }}>Round: {roundPts[0]}-{roundPts[1]}</div>}
          </div>
          {/* East */}
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', width: '60px', flexShrink: 0 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: '4px', flexWrap: 'wrap', justifyContent: 'center' }}><span style={{ fontSize: '10px', color: '#aaa' }}>{PLAYER_NAMES[3]}</span>{dealer === 3 && <DealerBadge />}</div>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '2px' }}>{Array.from({ length: 5 }, (_, i) => i < hands[3].length ? <Card key={i} card={{}} faceDown small /> : <div key={i} style={{ height: '50px' }} />)}</div>
            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px' }}>{bidInd(3)}<CardsDrawnIndicator count={drawn[3]} /></div>
            <TricksWonDisplay count={playerTricks[3]} hasHighTrump={highTrumpInfo.player === 3} />
          </div>
        </div>
        {/* South */}
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '3px', flexShrink: 0 }}>
          <TricksWonDisplay count={playerTricks[0]} hasHighTrump={highTrumpInfo.player === 0} />
          <div style={{ display: 'flex', justifyContent: 'center', flexWrap: 'wrap', gap: '3px', minHeight: '78px' }}>
            {hands[0].map((c, i) => <Card key={c.id} card={c} onClick={() => phase === 'discarding' && currentPlayer === 0 ? toggle(i) : phase === 'playing' && currentPlayer === 0 ? humanPlay(i) : null} selected={selected.includes(i)} playable={playable.includes(i)} disabled={(phase !== 'discarding' || currentPlayer !== 0) && (phase !== 'playing' || currentPlayer !== 0 || !playable.includes(i))} />)}
            {bidInd(0)}
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}><span style={{ fontSize: '11px', color: '#aaa' }}>{PLAYER_NAMES[0]}</span>{dealer === 0 && <DealerBadge />}{drawn[0] > 0 && <span style={{ fontSize: '10px', color: '#aaa' }}>drew {drawn[0]}</span>}</div>
        </div>
        {/* Buttons */}
        <div style={{ display: 'flex', justifyContent: 'center', gap: '6px', flexWrap: 'wrap', flexShrink: 0, minHeight: '44px', alignItems: 'center' }}>
          {phase === 'bidding' && currentPlayer === 0 && <>{[15,20,25,30].map(b => <button key={b} onClick={() => humanBid(b)} disabled={b <= highBid} style={{ padding: '8px 16px', fontSize: '14px', background: b <= highBid ? '#555' : '#2196f3', color: '#fff', border: 'none', borderRadius: '6px', cursor: b <= highBid ? 'not-allowed' : 'pointer', opacity: b <= highBid ? 0.5 : 1 }}>{b}</button>)}<button onClick={() => humanBid(0)} style={{ padding: '8px 16px', fontSize: '14px', background: '#666', color: '#fff', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>Pass</button></>}
          {phase === 'trump-select' && SUITS.map(s => <button key={s} onClick={() => selectTrump(s)} style={{ padding: '8px 16px', fontSize: '22px', background: 'rgba(0,0,0,0.5)', color: (s === '♥' || s === '♦') ? '#f44336' : '#fff', border: '2px solid #d4af37', borderRadius: '6px', cursor: 'pointer' }}>{s}</button>)}
          {phase === 'discarding' && currentPlayer === 0 && <button onClick={humanDiscard} disabled={hands[0].length - selected.length === 0} style={{ padding: '8px 20px', fontSize: '14px', background: hands[0].length - selected.length === 0 ? '#555' : '#4caf50', color: '#fff', border: 'none', borderRadius: '6px', cursor: hands[0].length - selected.length === 0 ? 'not-allowed' : 'pointer' }}>Done ({hands[0].length - selected.length} kept)</button>}
          {phase === 'round-end' && <button onClick={nextRound} style={{ padding: '8px 20px', fontSize: '14px', background: '#d4af37', color: '#000', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>Next Round</button>}
          {phase === 'game-over' && <button onClick={startGame} style={{ padding: '8px 20px', fontSize: '14px', background: '#d4af37', color: '#000', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>New Game</button>}
          {phase === 'dealing' && <button onClick={startGame} style={{ padding: '12px 32px', fontSize: '18px', background: '#d4af37', color: '#000', border: 'none', borderRadius: '10px', cursor: 'pointer', fontWeight: 'bold' }}>Start Game</button>}
        </div>
        {/* Last Trick */}
        {lastTrick && phase !== 'trick-end' && <div style={{ padding: '6px', background: 'rgba(0,0,0,0.3)', borderRadius: '6px', textAlign: 'center', flexShrink: 0 }}><div style={{ fontSize: '10px', marginBottom: '3px', color: '#aaa' }}>Last Trick:</div><div style={{ display: 'flex', justifyContent: 'center', gap: '3px' }}>{lastTrick.cards.map((tc, i) => <div key={i} style={{ textAlign: 'center' }}><Card card={tc.card} small disabled /><div style={{ fontSize: '8px', marginTop: '1px', color: tc.player === lastTrick.winner ? '#4caf50' : '#aaa', fontWeight: tc.player === lastTrick.winner ? 'bold' : 'normal' }}>{PLAYER_NAMES[tc.player]}</div></div>)}</div></div>}
        <ScoreTable roundHistory={history} />
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<FortyFivesGame />);
  </script>
</body>
</html>
