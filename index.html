<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>45s Card Game</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Palatino Linotype', Palatino, Georgia, serif; overflow: hidden; position: fixed; width: 100%; height: 100%; }
    html, body, #root { height: 100%; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
// 45s Card Game - Version 1.7
const { useState, useCallback, useRef, useEffect } = React;
const VERSION = '1.7';

const SUITS = ['♠', '♥', '♦', '♣'];
const RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
const PLAYER_NAMES = ['You', 'Player 2', 'Partner', 'Player 4'];
const getTeam = (player) => player % 2 === 0 ? 0 : 1;

function getTrumpRank(card, trumpSuit) {
  if (!card || !trumpSuit) return -1;
  const { rank, suit } = card;
  if (rank === 'A' && suit === '♥') return 100;
  if (suit !== trumpSuit) return -1;
  if (rank === '5') return 102;
  if (rank === 'J') return 101;
  if (rank === 'A') return 99;
  if (rank === 'K') return 98;
  if (rank === 'Q') return 97;
  if (suit === '♥' || suit === '♦') {
    return 80 + ['2','3','4','6','7','8','9','10'].indexOf(rank);
  } else {
    return 80 + ['10','9','8','7','6','4','3','2'].indexOf(rank);
  }
}

function getOffSuitRank(card) {
  if (!card) return -1;
  const { rank, suit } = card;
  if (suit === '♥' || suit === '♦') {
    return ['A','2','3','4','5','6','7','8','9','10','J','Q','K'].indexOf(rank);
  }
  return ['10','9','8','7','6','5','4','3','2','A','J','Q','K'].indexOf(rank);
}

function cardBeats(c1, c2, trumpSuit, ledSuit) {
  const t1 = getTrumpRank(c1, trumpSuit), t2 = getTrumpRank(c2, trumpSuit);
  if (t1 >= 0 && t2 >= 0) return t1 > t2;
  if (t1 >= 0) return true;
  if (t2 >= 0) return false;
  if (c1.suit !== ledSuit) return false;
  if (c2.suit !== ledSuit) return true;
  return getOffSuitRank(c1) > getOffSuitRank(c2);
}

function isTopThreeTrump(card, trumpSuit) {
  if (!card || !trumpSuit) return false;
  return (card.rank === '5' && card.suit === trumpSuit) || (card.rank === 'J' && card.suit === trumpSuit) || (card.rank === 'A' && card.suit === '♥');
}

function isTrump(card, trumpSuit) {
  if (!card || !trumpSuit) return false;
  return (card.rank === 'A' && card.suit === '♥') || card.suit === trumpSuit;
}

function createDeck() {
  const deck = [];
  for (const suit of SUITS) for (const rank of RANKS) deck.push({ rank, suit, id: `${rank}${suit}` });
  return deck;
}

function shuffleDeck(deck) {
  const s = [...deck];
  for (let i = s.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [s[i], s[j]] = [s[j], s[i]]; }
  return s;
}

function getPlayableCards(hand, trumpSuit, ledCard, ledSuit) {
  if (!hand || hand.length === 0) return [];
  if (!ledCard) return hand;
  if (isTrump(ledCard, trumpSuit)) {
    const trumpCards = hand.filter(c => isTrump(c, trumpSuit));
    if (trumpCards.length === 0) return hand;
    const ledRank = getTrumpRank(ledCard, trumpSuit);
    const must = [], canRenege = [];
    for (const c of trumpCards) {
      if (isTopThreeTrump(c, trumpSuit) && getTrumpRank(c, trumpSuit) > ledRank) canRenege.push(c);
      else must.push(c);
    }
    return must.length > 0 ? [...must, ...canRenege] : hand;
  } else {
    const follow = hand.filter(c => c.suit === ledSuit && !isTrump(c, trumpSuit));
    const trumps = hand.filter(c => isTrump(c, trumpSuit));
    return follow.length === 0 ? hand : [...follow, ...trumps];
  }
}

function determineTrickWinner(trick, trumpSuit, startPlayer) {
  if (trick.length !== 4) return null;
  const ledSuit = trick[0].suit;
  let winIdx = 0, winCard = trick[0];
  for (let i = 1; i < 4; i++) { if (cardBeats(trick[i], winCard, trumpSuit, ledSuit)) { winIdx = i; winCard = trick[i]; } }
  return (startPlayer + winIdx) % 4;
}

const hasCard = (hand, rank, suit) => hand.some(c => c.rank === rank && c.suit === suit);
const hasFive = (hand, trump) => hasCard(hand, '5', trump);
const hasJack = (hand, trump) => hasCard(hand, 'J', trump);
const hasAceHearts = (hand) => hasCard(hand, 'A', '♥');
const hasAceTrump = (hand, trump) => hasCard(hand, 'A', trump);
const countTrumps = (hand, trump) => hand.filter(c => isTrump(c, trump)).length;
const countHighTrumps = (hand, trump) => hand.filter(c => getTrumpRank(c, trump) >= 97).length;

function findBestTrumpSuit(hand) {
  let best = '♠', bestCount = 0, best5 = false, bestJ = false;
  for (const suit of SUITS) {
    const count = countTrumps(hand, suit), h5 = hasFive(hand, suit), hJ = hasJack(hand, suit);
    const score = (h5?1000:0) + (hJ?500:0) + count*10;
    const bestScore = (best5?1000:0) + (bestJ?500:0) + bestCount*10;
    if (score > bestScore) { best = suit; bestCount = count; best5 = h5; bestJ = hJ; }
  }
  return { suit: best, trumpCount: bestCount, has5: best5, hasJ: bestJ };
}

function decideBid(hand, currentHighBid, playerIndex, dealer, teamScores, oppScores) {
  const { suit, trumpCount, has5, hasJ } = findBestTrumpSuit(hand);
  const hasAH = hasAceHearts(hand), highT = countHighTrumps(hand, suit);
  const theyWin = (b) => oppScores + b >= 120;
  const farAhead = teamScores >= 100 && teamScores - oppScores >= 30;
  let bid = 0;
  if (has5 && hasJ && hasAH && trumpCount >= 4) bid = 30;
  else if (has5 && hasJ && trumpCount >= 3) bid = 25;
  else if (has5 && hasAH && trumpCount >= 4) bid = 25;
  else if (has5 && trumpCount >= 3) bid = 20;
  else if (has5 && trumpCount >= 2 && highT >= 2) bid = 20;
  else if (hasJ && trumpCount >= 4 && highT >= 3) bid = 20;
  else if (has5) bid = 15;
  else if (hasJ && trumpCount >= 3) bid = 15;
  else if (hasAH && trumpCount >= 3) bid = 15;
  else if (trumpCount >= 4 && highT >= 2) bid = 15;
  if (theyWin(20) && bid < 20 && ((has5 && trumpCount >= 2) || (hasJ && trumpCount >= 3))) bid = 20;
  if (theyWin(20) && currentHighBid >= 20 && bid < 25 && ((has5 && hasJ) || (has5 && trumpCount >= 4))) bid = 25;
  if (farAhead && !has5 && !hasJ) bid = 0;
  
  // Bid minimum necessary when last to bid (highBid + 5, not full hand strength)
  if (bid > currentHighBid && playerIndex === dealer && currentHighBid > 0) {
    bid = Math.min(bid, currentHighBid + 5);
  }
  
  if (bid <= currentHighBid) return playerIndex === dealer && currentHighBid === 0 ? { bid: 15, suit } : { bid: 0, suit: null };
  return { bid, suit };
}

function decideDiscard(hand, trumpSuit, isBidWinner) {
  const trumps = hand.filter(c => isTrump(c, trumpSuit));
  const offsuit = hand.filter(c => !isTrump(c, trumpSuit));
  let keep = [...trumps];
  
  if (isBidWinner && offsuit.length > 0) {
    // Group offsuit by suit and keep best card from each suit (diversify)
    const bySuit = {};
    for (const c of offsuit) {
      if (!bySuit[c.suit]) bySuit[c.suit] = [];
      bySuit[c.suit].push(c);
    }
    // Sort each suit by rank (highest first) and pick the best from each
    const bestPerSuit = [];
    for (const suit of Object.keys(bySuit)) {
      bySuit[suit].sort((a, b) => getOffSuitRank(b) - getOffSuitRank(a));
      bestPerSuit.push(bySuit[suit][0]);
    }
    // Only keep kings or aces if we have enough trump
    const strongOffsuit = bestPerSuit.filter(c => c.rank === 'K' || c.rank === 'A');
    if (strongOffsuit.length > 0 && trumps.length >= 3) {
      keep.push(strongOffsuit[0]);
    }
  }
  
  if (keep.length === 0 && hand.length > 0) {
    const sorted = [...hand].sort((a,b) => {
      const ar = isTrump(a,trumpSuit) ? getTrumpRank(a,trumpSuit)+100 : getOffSuitRank(a);
      const br = isTrump(b,trumpSuit) ? getTrumpRank(b,trumpSuit)+100 : getOffSuitRank(b);
      return br - ar;
    });
    keep = [sorted[0]];
  }
  return { keep, discard: hand.filter(c => !keep.some(k => k.id === c.id)) };
}

function getDefaultDiscardSelection(hand, trumpSuit) {
  return hand.map((c, i) => isTrump(c, trumpSuit) ? -1 : i).filter(i => i >= 0);
}

function chooseCardToPlay(hand, trumpSuit, trick, leader, player, bidWinner, highBid, cardsDrawn, knownOutOfTrump, trickNum, bidderHasLostTrick) {
  const led = trick[0] || null, ledSuit = led?.suit;
  const playable = getPlayableCards(hand, trumpSuit, led, ledSuit);
  if (playable.length <= 1) return playable[0] || hand[0];
  
  const myTeam = getTeam(player), partnerIdx = (player + 2) % 4;
  const myTeamBid = myTeam === getTeam(bidWinner);
  const iAmBidWinner = player === bidWinner;
  const partnerIsBidder = partnerIdx === bidWinner;
  const opp1Drawn = cardsDrawn[(player+1)%4] || 0;
  const opp2Drawn = cardsDrawn[(player+3)%4] || 0;
  const oppWeak = opp1Drawn >= 4 && opp2Drawn >= 4;
  const atLeastOneOppStrong = opp1Drawn < 4 || opp2Drawn < 4;
  const partnerWeak = (cardsDrawn[partnerIdx]||0) >= 4;
  const partnerOutOfTrump = knownOutOfTrump && knownOutOfTrump[partnerIdx];

  // Check if we have A♥ and A of trump - if so, prefer playing A trump first when appropriate
  const hasAH = playable.some(c => c.rank === 'A' && c.suit === '♥');
  const hasATrump = playable.some(c => c.rank === 'A' && c.suit === trumpSuit && trumpSuit !== '♥');

  if (!led) {
    const trumps = playable.filter(c => isTrump(c, trumpSuit));
    const nonTrumps = playable.filter(c => !isTrump(c, trumpSuit));
    const has5 = trumps.some(c => c.rank === '5' && c.suit === trumpSuit);
    
    // Bid winner leading logic
    if (iAmBidWinner && trumps.length > 0) {
      // For 25 bids (non-desperation): come out swinging with strongest trump until we lose a trick
      if (highBid >= 25 && !bidderHasLostTrick) {
        // Lead strongest trump - bang them out one after another
        return trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
      }
      
      // For 15/20 bids or after losing a trick on 25: lead the 5 aggressively
      // Exception: partner weak, at least one opponent strong, and we need partner's help
      if (has5) {
        const needPartnerHelp = partnerWeak && atLeastOneOppStrong && trumps.length < 4;
        if (!needPartnerHelp) {
          return trumps.find(c => c.rank === '5' && c.suit === trumpSuit);
        }
      }
      
      // Otherwise lead strongest trump
      return trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
    }
    
    // Non-bid-winner teammate leading
    if (myTeamBid && trumps.length >= 2) {
      if (has5 && oppWeak) return trumps.find(c => c.rank === '5' && c.suit === trumpSuit);
      // If holding A♥ + A of trump, play A of trump first
      if (hasAH && hasATrump) {
        return trumps.find(c => c.rank === 'A' && c.suit === trumpSuit);
      }
      return trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
    }
    if (partnerIsBidder && !partnerWeak && nonTrumps.length > 0) {
      return nonTrumps.reduce((l,c) => getOffSuitRank(c) < getOffSuitRank(l) ? c : l);
    }
    return playable.reduce((l,c) => {
      const cr = isTrump(c,trumpSuit) ? getTrumpRank(c,trumpSuit)+100 : getOffSuitRank(c);
      const lr = isTrump(l,trumpSuit) ? getTrumpRank(l,trumpSuit)+100 : getOffSuitRank(l);
      return cr < lr ? c : l;
    });
  }

  let winIdx = 0, winCard = trick[0];
  for (let i = 1; i < trick.length; i++) { if (cardBeats(trick[i], winCard, trumpSuit, ledSuit)) { winIdx = i; winCard = trick[i]; } }
  const winPlayer = (leader + winIdx) % 4;
  const partnerWinning = getTeam(winPlayer) === myTeam;

  // 2nd man low: when opponent leads offsuit and we're 2nd to play
  const positionInTrick = trick.length;
  if (positionInTrick === 1 && !isTrump(led, trumpSuit) && getTeam(leader) !== myTeam) {
    // We're 2nd to play after opponent led offsuit
    // Exception: if partner is known to be out of trump, we should try to win
    if (!partnerOutOfTrump) {
      const offsuit = playable.filter(c => !isTrump(c, trumpSuit));
      if (offsuit.length > 0) {
        // Throw lowest offsuit to give partner (4th position) the opportunity
        return offsuit.reduce((l,c) => getOffSuitRank(c) < getOffSuitRank(l) ? c : l);
      }
    }
  }

  if (trick.length === 2 && partnerIdx === bidWinner && bidWinner === leader && !isTrump(led, trumpSuit) && myTeamBid) {
    const trumps = playable.filter(c => isTrump(c, trumpSuit));
    if (trumps.length > 0) {
      // If holding A♥ + A of trump, play A of trump first
      if (hasAH && hasATrump) {
        return trumps.find(c => c.rank === 'A' && c.suit === trumpSuit) || trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
      }
      return trumps.reduce((b,c) => getTrumpRank(c,trumpSuit) > getTrumpRank(b,trumpSuit) ? c : b);
    }
  }

  if (partnerWinning) {
    return playable.reduce((l,c) => {
      const cr = isTrump(c,trumpSuit) ? getTrumpRank(c,trumpSuit)+200 : getOffSuitRank(c);
      const lr = isTrump(l,trumpSuit) ? getTrumpRank(l,trumpSuit)+200 : getOffSuitRank(l);
      return cr < lr ? c : l;
    });
  }

  const canWin = playable.filter(c => cardBeats(c, winCard, trumpSuit, ledSuit));
  if (canWin.length > 0) {
    return canWin.reduce((l,c) => {
      const cr = isTrump(c,trumpSuit) ? getTrumpRank(c,trumpSuit) : getOffSuitRank(c);
      const lr = isTrump(l,trumpSuit) ? getTrumpRank(l,trumpSuit) : getOffSuitRank(l);
      return cr < lr ? c : l;
    });
  }

  const nonTrump = playable.filter(c => !isTrump(c, trumpSuit));
  if (nonTrump.length > 0) return nonTrump.reduce((l,c) => getOffSuitRank(c) < getOffSuitRank(l) ? c : l);
  return playable.reduce((l,c) => getTrumpRank(c,trumpSuit) < getTrumpRank(l,trumpSuit) ? c : l);
}

const chooseTrumpSuit = (hand) => findBestTrumpSuit(hand).suit;

// UI Components
function TrickMarker({ isHighTrump }) {
  return (<div style={{ width: '14px', height: '18px', borderRadius: '2px', background: isHighTrump ? 'linear-gradient(135deg, #8b0000 0%, #5c0000 100%)' : 'linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%)', border: isHighTrump ? '1px solid #ff6666' : '1px solid #2d5a87' }} />);
}

function TricksWonDisplay({ count, hasHighTrump }) {
  if (count === 0) return null;
  return (<div style={{ display: 'flex', gap: '1px' }}>{Array.from({ length: count }, (_, i) => <TrickMarker key={i} isHighTrump={hasHighTrump && i === 0} />)}</div>);
}

function CardsDrawnIndicator({ count }) {
  const displayCount = Math.max(0, count || 0);
  return (<span style={{ fontSize: '9px', color: '#ffd700' }}>+{displayCount}</span>);
}

function DealerBadge() {
  return (<span style={{ padding: '1px 3px', background: '#d4af37', color: '#000', borderRadius: '2px', fontSize: '8px', fontWeight: 'bold' }}>DEALER</span>);
}

function Card({ card, onClick, disabled, selected, small, faceDown, playable }) {
  const isRed = card && (card.suit === '♥' || card.suit === '♦');
  const w = small ? '28px' : '48px', h = small ? '38px' : '68px';
  const base = { width: w, height: h, borderRadius: '4px', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', cursor: disabled ? 'default' : 'pointer', transition: 'all 0.1s', fontFamily: 'Georgia, serif', userSelect: 'none', flexShrink: 0 };
  if (faceDown) return (<div style={{ ...base, background: 'linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%)', border: '1px solid #2d5a87' }} />);
  return (
    <div onClick={disabled ? undefined : onClick} style={{ ...base, background: selected ? '#fffde7' : '#fff', border: playable ? '2px solid #2196f3' : selected ? '2px solid #ffc107' : '1px solid #ccc', boxShadow: selected || playable ? '0 2px 6px rgba(0,0,0,0.3)' : '0 1px 3px rgba(0,0,0,0.15)', transform: (selected || playable) && !disabled ? 'translateY(-2px)' : 'none', opacity: disabled && !playable ? 0.6 : 1 }}>
      <div style={{ color: isRed ? '#c62828' : '#212121', fontSize: small ? '11px' : '15px', fontWeight: 'bold', lineHeight: 1 }}>{card.rank}</div>
      <div style={{ color: isRed ? '#c62828' : '#212121', fontSize: small ? '14px' : '22px', lineHeight: 1 }}>{card.suit}</div>
    </div>
  );
}

function ScoreTable({ roundHistory }) {
  const [expanded, setExpanded] = useState(false);
  if (roundHistory.length === 0) return null;
  const maxVis = 2, needsCollapse = roundHistory.length > maxVis;
  const visible = (!needsCollapse || expanded) ? roundHistory : roundHistory.slice(-maxVis);
  return (
    <div style={{ background: 'rgba(0,0,0,0.4)', borderRadius: '4px', padding: '4px', fontSize: '10px' }}>
      {needsCollapse && <div onClick={() => setExpanded(!expanded)} style={{ textAlign: 'center', color: '#aaa', cursor: 'pointer', fontSize: '9px' }}>{expanded ? '▼ less' : `▲ +${roundHistory.length - maxVis}`}</div>}
      <table style={{ width: '100%', borderCollapse: 'collapse', textAlign: 'center' }}>
        <thead><tr><th style={{ padding: '1px 2px', borderBottom: '1px solid rgba(255,255,255,0.2)' }}>R</th><th colSpan="2" style={{ padding: '1px 2px', borderBottom: '1px solid rgba(255,255,255,0.2)', color: '#4caf50' }}>US</th><th colSpan="2" style={{ padding: '1px 2px', borderBottom: '1px solid rgba(255,255,255,0.2)', color: '#f44336' }}>THEM</th></tr></thead>
        <tbody>{visible.map((r, i) => {
          const rn = expanded || !needsCollapse ? i + 1 : roundHistory.length - maxVis + i + 1;
          return (<tr key={i}><td style={{ padding: '1px 2px' }}>{rn}</td><td style={{ padding: '1px 2px', color: '#4caf50' }}>{r.usRoundScore < 0 ? `(${Math.abs(r.usRoundScore)})` : r.usRoundScore}</td><td style={{ padding: '1px 2px', color: '#4caf50', fontWeight: 'bold' }}>{r.usTotal}</td><td style={{ padding: '1px 2px', color: '#f44336' }}>{r.themRoundScore < 0 ? `(${Math.abs(r.themRoundScore)})` : r.themRoundScore}</td><td style={{ padding: '1px 2px', color: '#f44336', fontWeight: 'bold' }}>{r.themTotal}</td></tr>);
        })}</tbody>
      </table>
    </div>
  );
}

function HelpModal({ isOpen, onClose }) {
  const [imageModalOpen, setImageModalOpen] = useState(false);
  
  if (!isOpen) return null;
  
  return (
    <>
      {/* Main Help Modal */}
      <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.85)', zIndex: 100, display: 'flex', justifyContent: 'center', alignItems: 'center', padding: '8px' }}>
        <div style={{ background: 'linear-gradient(135deg, #1a472a 0%, #0d2818 100%)', border: '2px solid #d4af37', borderRadius: '8px', width: '100%', maxWidth: '400px', maxHeight: '95%', display: 'flex', flexDirection: 'column', overflow: 'hidden' }}>
          {/* Modal Header */}
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '10px 12px', borderBottom: '1px solid rgba(212,175,55,0.3)' }}>
            <span style={{ fontSize: '16px', fontWeight: 'bold', color: '#d4af37' }}>Info & Help</span>
            <div onClick={onClose} style={{ width: '24px', height: '24px', border: '1px solid #aaa', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#aaa', fontSize: '16px', cursor: 'pointer' }}>✕</div>
          </div>
          {/* Modal Content - Scrollable */}
          <div style={{ flex: 1, overflowY: 'auto', padding: '12px', fontSize: '13px', lineHeight: 1.5, color: '#e8e4d9' }}>
            
            <p style={{ marginBottom: '12px' }}><strong style={{ color: '#d4af37' }}>Feedback & Bug Reports</strong></p>
            <p style={{ marginBottom: '12px' }}>To report bugs, UI suggestions and strategy suggestions, please email me at <a href="mailto:rrothberg@gmail.com?subject=45s%20Feedback" style={{ color: '#4caf50' }}>rrothberg@gmail.com</a></p>
            <p style={{ marginBottom: '16px' }}>Please include screenshots, version number and be VERY specific about what happened and what you would have expected to happen. Walk through it step by step unless the screenshot makes it obvious.</p>
            
            <p style={{ marginBottom: '12px' }}><strong style={{ color: '#d4af37' }}>About This Game</strong></p>
            <p style={{ marginBottom: '12px' }}>I developed this game in December 2025 to gain experience with using AI to code as well as to learn its capabilities and limitations. For training the AI players, I built an ML neural net simulator with a number of strategic parameters, and had it run 500,000 iterations. The statistics were pretty interesting to see.</p>
            <p style={{ marginBottom: '12px' }}>Here were the stats from my early 20,000 test simulator run. It bid 30 a lot at this early point, but the AI eventually learned that bidding 30 too aggressively generally results in getting set.</p>
            
            <div style={{ background: 'rgba(0,0,0,0.3)', padding: '8px', borderRadius: '4px', fontFamily: 'monospace', fontSize: '11px', marginBottom: '16px', whiteSpace: 'pre-wrap' }}>
{`--- BID SUCCESS RATES ---
15:  24339 attempts,  21213 made (87.2%)
20:  62328 attempts,  45645 made (73.2%)
25: 142015 attempts,  73908 made (52.0%)
30: 416045 attempts, 100988 made (24.3%)

--- KEY CARD IMPACT ---
With 5 of trump: 154728 bids, 51.5% success
Without:       489999 bids, 33.1% success
With J of trump: 146256 bids, 45.9% success
Without:       498471 bids, 35.0% success`}
            </div>
            
            <p style={{ marginBottom: '16px' }}>The AI used this data to learn how to bid much more effectively, and take into consideration that it will receive help from the kitty, draw and partner.</p>
            
            <p style={{ marginBottom: '12px' }}><strong style={{ color: '#d4af37' }}>AI Features</strong></p>
            <p style={{ marginBottom: '8px' }}>The AI players feature some pretty robust logic and strategy such as:</p>
            <ul style={{ marginLeft: '16px', marginBottom: '16px' }}>
              <li>Tracking estimated trump left for each player based on number of cards drawn</li>
              <li>Track trump remaining for each player based on card play (lead a 5, they throw offsuit, AI knows that player is out of trump)</li>
              <li>Change playing behavior as other players run out of trump</li>
              <li>Avoid pulling trump from partner when possible</li>
              <li>If only holding A♥ and A trump, on third man high or other situational play, play A trump</li>
              <li>Desperation bidding - if opponent will win game on 15 or 20 bid, consider overbidding</li>
              <li>2nd man low strategy</li>
              <li>Focus first on setting opponents, if that fails, switch to maximize points</li>
            </ul>
            
            <p style={{ marginBottom: '12px' }}><strong style={{ color: '#d4af37' }}>Possible Future Plans</strong></p>
            <ul style={{ marginLeft: '16px', marginBottom: '16px' }}>
              <li>Single player cutthroat</li>
              <li>Multiplayer partners over internet</li>
              <li>Multiplayer cutthroat over internet</li>
              <li>Optional rules such as allow drawing of 5 cards and flipping over the 5th</li>
              <li>Improvements to 2nd man low logic</li>
            </ul>
            
            <p style={{ marginBottom: '12px' }}><strong style={{ color: '#d4af37' }}>UI Guide</strong></p>
            <p style={{ marginBottom: '8px' }}>Tap the image below to view full screen:</p>
            <img 
              src="45s_table_diagram.jpeg" 
              onClick={() => setImageModalOpen(true)}
              style={{ width: '100%', borderRadius: '4px', border: '1px solid rgba(212,175,55,0.3)', cursor: 'pointer' }} 
              alt="UI Guide"
            />
          </div>
        </div>
      </div>
      
      {/* Full-screen Image Modal */}
      {imageModalOpen && (
        <div 
          onClick={() => setImageModalOpen(false)}
          style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.95)', zIndex: 200, display: 'flex', justifyContent: 'center', alignItems: 'center', padding: '8px', cursor: 'pointer' }}
        >
          <div onClick={(e) => e.stopPropagation()} style={{ position: 'relative', maxWidth: '100%', maxHeight: '100%' }}>
            <div 
              onClick={() => setImageModalOpen(false)}
              style={{ position: 'absolute', top: '-30px', right: '0', width: '24px', height: '24px', border: '1px solid #aaa', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#aaa', fontSize: '16px', cursor: 'pointer', background: 'rgba(0,0,0,0.5)' }}
            >✕</div>
            <img 
              src="45s_table_diagram.jpeg" 
              style={{ maxWidth: '100%', maxHeight: 'calc(100vh - 40px)', objectFit: 'contain' }} 
              alt="UI Guide Full Screen"
            />
          </div>
        </div>
      )}
    </>
  );
}

function FortyFivesGame() {
  const [phase, setPhase] = useState('dealing');
  const [hands, setHands] = useState([[],[],[],[]]);
  const [kitty, setKitty] = useState([]);
  const [deck, setDeck] = useState([]);
  const [dealer, setDealer] = useState(0);
  const [currentPlayer, setCurrentPlayer] = useState(1);
  const [bids, setBids] = useState([null,null,null,null]);
  const [highBid, setHighBid] = useState(0);
  const [bidWinner, setBidWinner] = useState(null);
  const [trumpSuit, setTrumpSuit] = useState(null);
  const [trick, setTrick] = useState([]);
  const [trickCards, setTrickCards] = useState([]);
  const [trickLeader, setTrickLeader] = useState(null);
  const [tricksWon, setTricksWon] = useState([0,0]);
  const [playerTricks, setPlayerTricks] = useState([0,0,0,0]);
  const [roundPts, setRoundPts] = useState([0,0]);
  const [scores, setScores] = useState([0,0]);
  const [trickNum, setTrickNum] = useState(0);
  const [selected, setSelected] = useState([]);
  const [msg, setMsg] = useState('');
  const [lastTrick, setLastTrick] = useState(null);
  const [aiTrump, setAiTrump] = useState(null);
  const [highTrumpInfo, setHighTrumpInfo] = useState({ rank: -1, player: -1 });
  const [history, setHistory] = useState([]);
  const [drawn, setDrawn] = useState([0,0,0,0]);
  const [animating, setAnimating] = useState(null);
  const [wasBagged, setWasBagged] = useState(false);
  const [helpOpen, setHelpOpen] = useState(false);
  const [knownOutOfTrump, setKnownOutOfTrump] = useState([false, false, false, false]);
  const [bidderLostTrick, setBidderLostTrick] = useState(false);
  const timer = useRef(null);
  
  useEffect(() => () => { if (timer.current) clearTimeout(timer.current); }, []);

  const startGame = useCallback(() => {
    if (timer.current) clearTimeout(timer.current);
    setScores([0,0]); setHistory([]); setDealer(0); dealRound(0, [0,0]);
  }, []);

  const dealRound = useCallback((dlr, totals) => {
    const d = shuffleDeck(createDeck());
    const h = [d.slice(0,5), d.slice(5,10), d.slice(10,15), d.slice(15,20)];
    const k = d.slice(20,23), rem = d.slice(23);
    setHands(h); setKitty(k); setDeck(rem);
    setBids([null,null,null,null]); setHighBid(0); setBidWinner(null); setTrumpSuit(null);
    setTrick([]); setTrickCards([]); setTricksWon([0,0]); setPlayerTricks([0,0,0,0]);
    setRoundPts([0,0]); setTrickNum(0); setSelected([]); setLastTrick(null);
    setAiTrump(null); setTrickLeader(null); setHighTrumpInfo({ rank: -1, player: -1 });
    setDrawn([0,0,0,0]); setAnimating(null); setWasBagged(false); 
    setKnownOutOfTrump([false, false, false, false]);
    setBidderLostTrick(false);
    setPhase('bidding');
    const first = (dlr + 1) % 4; setCurrentPlayer(first);
    if (first !== 0) { setMsg(`${PLAYER_NAMES[first]} bidding...`); timer.current = setTimeout(() => doBid(first, h, dlr, [null,null,null,null], 0, totals), 800); }
    else setMsg('Your bid');
  }, []);

  const doBid = useCallback((p, h, dlr, curBids, curHigh, totals) => {
    if (p === 0) return;
    const team = totals[getTeam(p)], opp = totals[1-getTeam(p)];
    const dec = decideBid(h[p], curHigh, p, dlr, team, opp);
    const newBids = [...curBids]; newBids[p] = dec.bid; setBids(newBids);
    let newHigh = curHigh, winner = null;
    if (dec.bid > curHigh) { newHigh = dec.bid; setHighBid(dec.bid); setAiTrump(dec.suit); winner = p; }
    if (newBids.every(b => b !== null)) {
      let fw = winner; if (!fw) { let m = 0; for (let i = 0; i < 4; i++) if (newBids[i] > m) { m = newBids[i]; fw = i; } }
      let bagged = false;
      if (newHigh === 0) { fw = dlr; newBids[dlr] = 15; setBids(newBids); setHighBid(15); newHigh = 15; bagged = true; }
      setWasBagged(bagged);
      setBidWinner(fw);
      if (fw === 0) { setPhase('trump-select'); setMsg(bagged ? 'You were BAGGED! Pick trump' : 'Pick trump'); }
      else { const t = aiTrump || chooseTrumpSuit(h[fw]); finishBid(fw, t, h, newHigh, totals, dlr, bagged); }
    } else {
      const next = (p + 1) % 4; setCurrentPlayer(next);
      if (next === 0) setMsg('Your bid');
      else { setMsg(`${PLAYER_NAMES[next]} bidding...`); timer.current = setTimeout(() => doBid(next, h, dlr, newBids, newHigh, totals), 800); }
    }
  }, [aiTrump]);

  const humanBid = useCallback((amt) => {
    const newBids = [...bids]; newBids[0] = amt; setBids(newBids);
    let newHigh = highBid; if (amt > highBid) { newHigh = amt; setHighBid(amt); }
    if (newBids.every(b => b !== null)) {
      let w = null, m = 0; for (let i = 0; i < 4; i++) if (newBids[i] > m) { m = newBids[i]; w = i; }
      let bagged = false;
      if (m === 0) { w = dealer; newBids[dealer] = 15; setBids(newBids); setHighBid(15); newHigh = 15; bagged = true; }
      setWasBagged(bagged);
      setBidWinner(w);
      if (w === 0) { setPhase('trump-select'); setMsg(bagged ? 'You were BAGGED! Pick trump' : 'Pick trump'); }
      else { const t = aiTrump || chooseTrumpSuit(hands[w]); finishBid(w, t, hands, newHigh, scores, dealer, bagged); }
    } else { setCurrentPlayer(1); setMsg(`${PLAYER_NAMES[1]} bidding...`); timer.current = setTimeout(() => doBid(1, hands, dealer, newBids, newHigh, scores), 800); }
  }, [bids, highBid, dealer, hands, aiTrump, scores]);

  const selectTrump = useCallback((s) => finishBid(0, s, hands, highBid, scores, dealer, wasBagged), [hands, highBid, scores, dealer, wasBagged]);

  const finishBid = useCallback((w, t, h, hb, totals, dlr, bagged) => {
    setTrumpSuit(t); setBidWinner(w); setHighBid(hb);
    const newH = h.map((hand, i) => i === w ? [...hand, ...kitty] : [...hand]);
    setHands(newH); setKitty([]);
    setSelected(getDefaultDiscardSelection(newH[0], t));
    const first = (dlr + 1) % 4; setPhase('discarding'); setCurrentPlayer(first);
    const bagMsg = bagged ? ' (BAGGED)' : '';
    if (first === 0) setMsg(`Discard (keep 1+)${bagMsg}`);
    else { setMsg(`${PLAYER_NAMES[first]} discarding...${bagMsg}`); timer.current = setTimeout(() => aiDiscard(first, newH, t, w, hb, totals, dlr, [0,0,0,0], deck), 500); }
  }, [kitty, deck]);

  const aiDiscard = useCallback((p, h, t, bw, hb, totals, dlr, curDrawn, curDeck) => {
    const { keep } = decideDiscard(h[p], t, p === bw);
    const newH = h.map(x => [...x]); newH[p] = keep;
    let d = [...curDeck]; const dc = Math.max(0, 5 - keep.length);
    if (dc > 0 && d.length >= dc) { newH[p] = [...newH[p], ...d.splice(0, dc)]; }
    const newDrawn = [...curDrawn]; newDrawn[p] = dc;
    setHands(newH); setDeck(d); setDrawn(newDrawn);
    const next = (p + 1) % 4, start = (dlr + 1) % 4;
    if (next === start) startPlay(bw, newH, t, hb, totals, newDrawn);
    else { setCurrentPlayer(next);
      if (next === 0) { setSelected(getDefaultDiscardSelection(newH[0], t)); setMsg('Discard (keep 1+)'); }
      else { setMsg(`${PLAYER_NAMES[next]} discarding...`); timer.current = setTimeout(() => aiDiscard(next, newH, t, bw, hb, totals, dlr, newDrawn, d), 500); }
    }
  }, []);

  const humanDiscard = useCallback(() => {
    const keep = hands[0].filter((_, i) => !selected.includes(i));
    if (keep.length === 0) { setMsg('Keep at least 1!'); return; }
    const newH = hands.map(x => [...x]); newH[0] = keep;
    let d = [...deck]; const dc = Math.max(0, 5 - keep.length);
    if (dc > 0 && d.length >= dc) { newH[0] = [...newH[0], ...d.splice(0, dc)]; }
    const newDrawn = [...drawn]; newDrawn[0] = dc;
    setHands(newH); setDeck(d); setDrawn(newDrawn); setSelected([]);
    const next = 1, start = (dealer + 1) % 4;
    if (next === start) startPlay(bidWinner, newH, trumpSuit, highBid, scores, newDrawn);
    else { setCurrentPlayer(next); setMsg(`${PLAYER_NAMES[next]} discarding...`); timer.current = setTimeout(() => aiDiscard(next, newH, trumpSuit, bidWinner, highBid, scores, dealer, newDrawn, d), 500); }
  }, [hands, selected, deck, dealer, bidWinner, trumpSuit, highBid, scores, drawn]);

  const startPlay = useCallback((leader, h, t, hb, totals, dr) => {
    setPhase('playing'); setTrick([]); setTrickCards([]); setTrickLeader(leader);
    setCurrentPlayer(leader); setTrickNum(1); setPlayerTricks([0,0,0,0]); setHighTrumpInfo({ rank: -1, player: -1 });
    setKnownOutOfTrump([false, false, false, false]);
    setBidderLostTrick(false);
    if (leader === 0) setMsg('Your lead');
    else { setMsg(`${PLAYER_NAMES[leader]} leads...`); timer.current = setTimeout(() => aiPlay(leader, h, [], t, leader, 1, [0,0], [0,0], { rank: -1, player: -1 }, bidWinner, hb, totals, dr, [0,0,0,0], [false,false,false,false], false), 700); }
  }, [bidWinner]);

  const aiPlay = useCallback((p, h, tc, t, lead, tn, tw, rp, hti, bw, hb, totals, dr, pt, koot, blt) => {
    const hand = h[p]; if (!hand || !hand.length) return;
    const trk = tc.map(x => x.card);
    const card = chooseCardToPlay(hand, t, trk, lead, p, bw, hb, dr, koot, tn, blt);
    const idx = hand.findIndex(c => c.id === card.id);
    const newH = h.map((x, i) => i === p ? x.filter((_, j) => j !== idx) : [...x]);
    const newTC = [...tc, { card, player: p }], newTrk = newTC.map(x => x.card);
    setHands(newH); setTrickCards(newTC); setTrick(newTrk);
    if (newTC.length === 4) timer.current = setTimeout(() => evalTrick(newTrk, newTC, t, lead, newH, tn, tw, rp, hti, bw, hb, totals, dr, pt, koot, blt), 500);
    else { const next = (p + 1) % 4; setCurrentPlayer(next);
      if (next === 0) setMsg('Your turn');
      else { setMsg(`${PLAYER_NAMES[next]}...`); timer.current = setTimeout(() => aiPlay(next, newH, newTC, t, lead, tn, tw, rp, hti, bw, hb, totals, dr, pt, koot, blt), 600); }
    }
  }, []);

  const humanPlay = useCallback((ci) => {
    if (phase !== 'playing' || currentPlayer !== 0) return;
    const hand = hands[0], card = hand[ci];
    const led = trick[0] || null, ls = led?.suit;
    const playable = getPlayableCards(hand, trumpSuit, led, ls);
    if (!playable.some(c => c.id === card.id)) { setMsg('Must follow suit!'); return; }
    const newH = hands.map((x, i) => i === 0 ? x.filter((_, j) => j !== ci) : [...x]);
    const newTC = [...trickCards, { card, player: 0 }], newTrk = newTC.map(x => x.card);
    setHands(newH); setTrickCards(newTC); setTrick(newTrk);
    if (newTC.length === 4) timer.current = setTimeout(() => evalTrick(newTrk, newTC, trumpSuit, trickLeader, newH, trickNum, tricksWon, roundPts, highTrumpInfo, bidWinner, highBid, scores, drawn, playerTricks, knownOutOfTrump, bidderLostTrick), 500);
    else { setCurrentPlayer(1); setMsg(`${PLAYER_NAMES[1]}...`); timer.current = setTimeout(() => aiPlay(1, newH, newTC, trumpSuit, trickLeader, trickNum, tricksWon, roundPts, highTrumpInfo, bidWinner, highBid, scores, drawn, playerTricks, knownOutOfTrump, bidderLostTrick), 600); }
  }, [phase, currentPlayer, hands, trick, trickCards, trumpSuit, trickLeader, trickNum, tricksWon, roundPts, highTrumpInfo, bidWinner, highBid, scores, drawn, playerTricks, knownOutOfTrump, bidderLostTrick]);

  const evalTrick = useCallback((trk, tc, t, lead, h, tn, tw, rp, hti, bw, hb, totals, dr, pt, koot, blt) => {
    const winner = determineTrickWinner(trk, t, lead), team = getTeam(winner);
    let highT = -1; for (const c of trk) { const r = getTrumpRank(c, t); if (r > highT) highT = r; }
    let newHTI = hti; if (highT > hti.rank) newHTI = { rank: highT, player: winner };
    setHighTrumpInfo(newHTI);
    const newTW = [...tw]; newTW[team]++;
    const newPT = [...pt]; newPT[winner]++;
    const newRP = [...rp]; newRP[team] += 5;
    setTricksWon(newTW); setPlayerTricks(newPT); setRoundPts(newRP);
    
    // Track if bidder lost a trick
    let newBLT = blt;
    if (winner !== bw && getTeam(winner) !== getTeam(bw)) {
      newBLT = true;
      setBidderLostTrick(true);
    }
    
    // Track who is out of trump based on plays
    const ledCard = trk[0];
    const newKOOT = [...koot];
    if (isTrump(ledCard, t)) {
      // Trump was led - anyone who didn't play trump (and isn't holding top 3) is out
      for (let i = 0; i < 4; i++) {
        const playerIdx = (lead + i) % 4;
        const playedCard = trk[i];
        if (!isTrump(playedCard, t)) {
          newKOOT[playerIdx] = true;
        }
      }
    }
    setKnownOutOfTrump(newKOOT);
    
    setLastTrick({ cards: tc, winner }); setAnimating(winner); setPhase('trick-end');
    setMsg(`${PLAYER_NAMES[winner]} wins!`);
    timer.current = setTimeout(() => {
      setAnimating(null);
      if (tn >= 5) { 
        const fp = [...newRP]; 
        if (newHTI.rank >= 0) fp[getTeam(newHTI.player)] += 5; 
        endRound(fp, h, bw, hb, totals); 
      }
      else { setTrick([]); setTrickCards([]); setTrickLeader(winner); setCurrentPlayer(winner); setTrickNum(tn + 1); setPhase('playing');
        if (winner === 0) setMsg('Your lead');
        else { setMsg(`${PLAYER_NAMES[winner]} leads...`); timer.current = setTimeout(() => aiPlay(winner, h, [], t, winner, tn + 1, newTW, newRP, newHTI, bw, hb, totals, dr, newPT, newKOOT, newBLT), 700); }
      }
    }, 1200);
  }, []);

  const endRound = useCallback((fp, h, bw, hb, totals) => {
    const bt = getTeam(bw), newS = [...totals];
    let us = 0, them = 0;
    const made = fp[bt] >= hb;
    if (made) { newS[bt] += fp[bt]; bt === 0 ? us = fp[0] : them = fp[1]; }
    else { newS[bt] -= hb; bt === 0 ? us = -hb : them = -hb; }
    const ot = 1 - bt; newS[ot] += fp[ot]; ot === 0 ? us = fp[0] : them = fp[1];
    setScores(newS);
    setHistory(p => [...p, { usRoundScore: us, themRoundScore: them, usTotal: newS[0], themTotal: newS[1] }]);
    if (newS[0] >= 120 || newS[1] >= 120) {
      const w = (newS[0] >= 120 && newS[1] >= 120) ? bt : (newS[0] >= 120 ? 0 : 1);
      setPhase('game-over'); setMsg(`${w === 0 ? 'You win!' : 'They win!'}`);
    } else {
      setPhase('round-end');
      // Updated round end messages
      const bidTeamName = bt === 0 ? 'We' : 'They';
      const possessive = bt === 0 ? 'our' : 'their';
      const resultMsg = made ? `${bidTeamName} made ${possessive} ${hb} bid` : `${bidTeamName} were set ${hb}`;
      setMsg(resultMsg);
    }
  }, []);

  const nextRound = useCallback(() => { const nd = (dealer + 1) % 4; setDealer(nd); dealRound(nd, scores); }, [dealer, scores]);
  const toggle = useCallback((i) => setSelected(p => p.includes(i) ? p.filter(x => x !== i) : [...p, i]), []);

  const playable = phase === 'playing' && currentPlayer === 0 ? (() => {
    const led = trick[0] || null, ls = led?.suit;
    const p = getPlayableCards(hands[0], trumpSuit, led, ls);
    return hands[0].map((c, i) => p.some(x => x.id === c.id) ? i : -1).filter(i => i >= 0);
  })() : [];

  // Bid indicator with BAGGED support - yellow pass indicator, red background for bagged
  const bidInd = (pi) => {
    if (phase === 'bidding') { 
      if (bids[pi] === null) return null; 
      return <span style={{ padding: '2px 4px', background: bids[pi] > 0 ? '#2196f3' : '#c9a227', borderRadius: '3px', fontSize: '10px', marginLeft: '4px', color: bids[pi] > 0 ? '#fff' : '#000' }}>{bids[pi] > 0 ? bids[pi] : 'Pass'}</span>; 
    }
    if (bidWinner !== pi || !trumpSuit) return null;
    const showBagged = wasBagged && pi === bidWinner;
    return <span style={{ padding: '2px 4px', background: showBagged ? '#c62828' : '#2196f3', borderRadius: '3px', fontSize: '10px', marginLeft: '4px', color: '#fff' }}>{highBid}<span style={{ color: (trumpSuit === '♥' || trumpSuit === '♦') ? '#ffcdd2' : '#fff' }}>{trumpSuit}</span>{showBagged && <span style={{ marginLeft: '2px' }}>BAGGED</span>}</span>;
  };

  const winPos = (w) => ({ 0: { x: 0, y: 80 }, 1: { x: -80, y: 0 }, 2: { x: 0, y: -80 }, 3: { x: 80, y: 0 } }[w]);

  return (
    <div style={{ height: '100%', display: 'flex', flexDirection: 'column', background: 'linear-gradient(135deg, #1a472a 0%, #0d2818 50%, #0a1f12 100%)', padding: '4px', fontFamily: 'Arial, sans-serif', color: '#e8e4d9' }}>
      {/* Header with Help button */}
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '4px 8px', background: 'rgba(0,0,0,0.3)', borderRadius: '6px', marginBottom: '4px' }}>
        <div style={{ fontSize: '14px', fontWeight: 'bold', color: '#d4af37' }}>45s <span style={{ fontSize: '8px', color: '#666' }}>v{VERSION}</span></div>
        <div 
          onClick={() => setHelpOpen(true)} 
          style={{ width: '20px', height: '20px', borderRadius: '50%', border: '1px solid #d4af37', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#d4af37', fontSize: '12px', cursor: 'pointer', fontWeight: 'bold' }}
        >?</div>
        <div style={{ fontSize: '12px' }}><span style={{ color: '#4caf50' }}>Us:{scores[0]}</span> | <span style={{ color: '#f44336' }}>Them:{scores[1]}</span></div>
      </div>
      {/* Message */}
      <div style={{ textAlign: 'center', padding: '4px', background: 'rgba(0,0,0,0.4)', borderRadius: '4px', fontSize: '12px', color: '#ffd700', marginBottom: '4px' }}>{msg}</div>
      {/* Game */}
      <div style={{ flex: 1, display: 'flex', flexDirection: 'column', minHeight: 0 }}>
        {/* North */}
        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', padding: '2px 0' }}>
          <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
            <span style={{ fontSize: '11px', color: '#aaa' }}>{PLAYER_NAMES[2]}</span>
            {dealer === 2 && <DealerBadge />}
            <CardsDrawnIndicator count={drawn[2]} />
          </div>
          <div style={{ display: 'flex', gap: '1px' }}>{hands[2].map((_, i) => <Card key={i} card={{}} faceDown small />)}</div>
          <div style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
            {bidInd(2)}
            <TricksWonDisplay count={playerTricks[2]} hasHighTrump={highTrumpInfo.player === 2} />
          </div>
        </div>
        {/* Middle row */}
        <div style={{ flex: 1, display: 'flex', alignItems: 'center', minHeight: 0 }}>
          {/* West */}
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', width: '50px' }}>
            <div style={{ fontSize: '10px', color: '#aaa', textAlign: 'center' }}>{PLAYER_NAMES[1]}</div>
            {dealer === 1 && <DealerBadge />}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1px' }}>{hands[1].map((_, i) => <Card key={i} card={{}} faceDown small />)}</div>
            <CardsDrawnIndicator count={drawn[1]} />
            {bidInd(1)}
            <TricksWonDisplay count={playerTricks[1]} hasHighTrump={highTrumpInfo.player === 1} />
          </div>
          {/* Center - Larger table with always-visible trump */}
          <div style={{ flex: 1, display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
            <div style={{ width: '150px', height: '150px', display: 'flex', justifyContent: 'center', alignItems: 'center', background: 'rgba(0,0,0,0.3)', borderRadius: '50%', border: '2px solid rgba(212,175,55,0.3)', position: 'relative' }}>
              {/* Trump suit always visible in center (behind cards) */}
              {trumpSuit && <div style={{ position: 'absolute', fontSize: '64px', color: (trumpSuit === '♥' || trumpSuit === '♦') ? '#f44336' : '#fff', opacity: 0.3, zIndex: 0 }}>{trumpSuit}</div>}
              {trickCards.map((tc, i) => {
                const pos = [{ bottom: '4px', left: '50%', transform: 'translateX(-50%)' }, { left: '4px', top: '50%', transform: 'translateY(-50%)' }, { top: '4px', left: '50%', transform: 'translateX(-50%)' }, { right: '4px', top: '50%', transform: 'translateY(-50%)' }][tc.player];
                const ani = animating !== null, wp = ani ? winPos(animating) : null;
                return <div key={i} style={{ position: 'absolute', ...pos, zIndex: 1, transition: ani ? 'all 0.4s ease' : 'none', transform: ani ? `translate(${wp.x}px, ${wp.y}px) scale(0.2)` : pos.transform, opacity: ani ? 0 : 1 }}><Card card={tc.card} small disabled /></div>;
              })}
              {(phase === 'playing' || phase === 'trick-end') && <div style={{ position: 'absolute', bottom: '-16px', fontSize: '10px', color: '#aaa' }}>{roundPts[0]}-{roundPts[1]}</div>}
            </div>
          </div>
          {/* East */}
          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '2px', width: '50px' }}>
            <div style={{ fontSize: '10px', color: '#aaa', textAlign: 'center' }}>{PLAYER_NAMES[3]}</div>
            {dealer === 3 && <DealerBadge />}
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1px' }}>{hands[3].map((_, i) => <Card key={i} card={{}} faceDown small />)}</div>
            <CardsDrawnIndicator count={drawn[3]} />
            {bidInd(3)}
            <TricksWonDisplay count={playerTricks[3]} hasHighTrump={highTrumpInfo.player === 3} />
          </div>
        </div>
        {/* South */}
        <div style={{ padding: '4px 0' }}>
          <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '4px', marginBottom: '4px' }}>
            <TricksWonDisplay count={playerTricks[0]} hasHighTrump={highTrumpInfo.player === 0} />
            <span style={{ fontSize: '11px', color: '#aaa' }}>{PLAYER_NAMES[0]}</span>
            {dealer === 0 && <DealerBadge />}
            {bidInd(0)}
            <CardsDrawnIndicator count={drawn[0]} />
          </div>
          <div style={{ display: 'flex', justifyContent: 'center', gap: '2px', minHeight: '68px' }}>
            {hands[0].map((c, i) => <Card key={c.id} card={c} onClick={() => phase === 'discarding' && currentPlayer === 0 ? toggle(i) : phase === 'playing' && currentPlayer === 0 ? humanPlay(i) : null} selected={selected.includes(i)} playable={playable.includes(i)} disabled={(phase !== 'discarding' || currentPlayer !== 0) && (phase !== 'playing' || currentPlayer !== 0 || !playable.includes(i))} />)}
          </div>
        </div>
        {/* Buttons - yellow Pass button, "Discard (x)" text */}
        <div style={{ display: 'flex', justifyContent: 'center', gap: '4px', flexWrap: 'wrap', padding: '4px 0' }}>
          {phase === 'bidding' && currentPlayer === 0 && <>{[15,20,25,30].map(b => <button key={b} onClick={() => humanBid(b)} disabled={b <= highBid} style={{ padding: '6px 12px', fontSize: '12px', background: b <= highBid ? '#555' : '#2196f3', color: '#fff', border: 'none', borderRadius: '4px', opacity: b <= highBid ? 0.5 : 1 }}>{b}</button>)}<button onClick={() => humanBid(0)} style={{ padding: '6px 12px', fontSize: '12px', background: '#c9a227', color: '#000', border: 'none', borderRadius: '4px' }}>Pass</button></>}
          {phase === 'trump-select' && SUITS.map(s => <button key={s} onClick={() => selectTrump(s)} style={{ padding: '6px 14px', fontSize: '18px', background: 'rgba(0,0,0,0.5)', color: (s === '♥' || s === '♦') ? '#f44336' : '#fff', border: '1px solid #d4af37', borderRadius: '4px' }}>{s}</button>)}
          {phase === 'discarding' && currentPlayer === 0 && <button onClick={humanDiscard} style={{ padding: '6px 16px', fontSize: '12px', background: '#4caf50', color: '#fff', border: 'none', borderRadius: '4px' }}>Discard ({selected.length})</button>}
          {phase === 'round-end' && <button onClick={nextRound} style={{ padding: '6px 16px', fontSize: '12px', background: '#d4af37', color: '#000', border: 'none', borderRadius: '4px' }}>Next</button>}
          {phase === 'game-over' && <button onClick={startGame} style={{ padding: '6px 16px', fontSize: '12px', background: '#d4af37', color: '#000', border: 'none', borderRadius: '4px' }}>New Game</button>}
          {phase === 'dealing' && <button onClick={startGame} style={{ padding: '10px 24px', fontSize: '14px', background: '#d4af37', color: '#000', border: 'none', borderRadius: '6px', fontWeight: 'bold' }}>Start</button>}
        </div>
        {/* Last Trick - fixed height container to prevent layout shift */}
        <div style={{ height: '44px', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          {lastTrick && phase !== 'trick-end' && <div style={{ display: 'flex', alignItems: 'center', gap: '2px', padding: '2px', background: 'rgba(0,0,0,0.2)', borderRadius: '4px' }}><span style={{ fontSize: '9px', color: '#aaa' }}>Last:</span>{lastTrick.cards.map((tc, i) => <Card key={i} card={tc.card} small disabled />)}</div>}
        </div>
        {/* Score table */}
        <ScoreTable roundHistory={history} />
      </div>
      {/* Help Modal */}
      <HelpModal isOpen={helpOpen} onClose={() => setHelpOpen(false)} />
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<FortyFivesGame />);
  </script>
</body>
</html>
